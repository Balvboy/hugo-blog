---
title: "MySQL的索引"
date: 2021-06-25T16:34:37+08:00
author:     "zhouyang"
draft: true
tags:
    - mysql
categories: [ MySQL ]   
---

# 数据页
是InnoDB管理存储空间的基本单位，一个页的大小一般是16KB。所以数据库读写一次最少都要16KB。

InnoDB为了不同的目的而设计了许多种不同类型的页，比如存放表空间头部信息的页，存放Insert Buffer信息的页，存放INODE信息的页，存放undo日志信息的页等等等等。

我们主要需要了解的是存放我们表中记录的页类型，官方称之为索引页，但我们我还是先称之为数据页。

## 数据页格式

![](/img/datapage.png)

|名称|中文名|占用空间大小|简单描述|
|:--:|:--:|:--:|:--|
|`File Header`|文件头部|`38`字节|页的一些通用信息|
|`Page Header`|页面头部|`56`字节|数据页专有的一些信息|
|`Infimum + Supremum`|最小记录和最大记录|`26`字节|两个虚拟的行记录|
|`User Records`|用户记录|不确定|实际存储的行记录内容|
|`Free Space`|空闲空间|不确定|页中尚未使用的空间|
|`Page Directory`|页面目录|不确定|页中的某些记录的相对位置,可以理解为为了加快在页面中的搜索速度而实现的针对该数据页记录的目录|
|`File Trailer`|文件尾部|`8`字节|校验页是否完整|


## 数据页如何存储记录

记录会被存储到`User Records`部分，但是在数据页刚被分配的时候，User Records为空，每当我们插入一条记录，都会从Free Space部分，也就是尚未使用的存储空间中申请一个记录大小的空间划分到User Records部分，当Free Space部分的空间全部被User Records部分替代掉之后，也就意味着这个页使用完了。

### 记录行

记录是以记录行的形式添加到 User Records 中的，下面呢我们大概来了解一下记录行的格式

![](/img/recorddata.png)

我们看到有很多我们熟悉的

- 变长字段列表
- null值列表
  - 记录允许为null的字段，是否为null，每个字段使用1bit来表示
  - 如果所有字段都不能为null，则在记录行中就没有这个部分
  - 这就是我们经常说的为什么字段设置为null会多占用空间，用1个bit来表示1个nullable字段是否为空
  - MySQL规定NULL值列表必须用整数个字节的位表示，如果使用的二进制位个数不是整数个字节，则在字节的高位补0，就算只有1个字段没有设置not null，那么也需要使用1字节来存储null列表
  - 另外需要注意的点是，null值列表中表示的字段顺序和后面记录中字段的顺序是相反的。
- 记录头信息
  - 这个在数据页结构很重要，下面我们单独来说
- 隐藏字段
  - 事务id 和 回滚指针。在事务和MVCC中起到重要作用
- 记录中字段值
  - 这个就是我们自己定义的字段里存储的值

### 记录头信息

|名称|大小bit|描述|
|:--:|:--:|:--:|
|`预留位1`|`1`|没有使用|
|`预留位2`|`1`|没有使用|
|`delete_mask`|`1`|标记该记录是否被删除|
|`min_rec_mask`|`1`|B+树的每层非叶子节点中的最小记录都会添加该标记|
|`n_owned`|`4`|<span style="color:red">表示当前记录拥有的记录数，每个分组的最后一条记录，用来保存这个分组中有几条记录</span>|
|`heap_no`|`13`|表示当前记录在记录堆的位置信息|
|`record_type`|`3`|表示当前记录的类型，`0`表示普通记录，`1`表示B+树非叶节点记录，`2`表示最小记录，`3`表示最大记录|
|`next_record`|`16`|<span style="color:red">表示下一条记录的相对位置; 就是依靠它，一个数据页中的所有记录行，就串成了一个长长的单向链表</span>|

## Page Directory
上面我们了解到数据页中存储的就是一条条的记录，每个数据页一般来说有16KB大小，这样的一个数据页根据存储的表数据不同，能够存下几百到上千条记录行。上面我们了解到页中的所有的记录行是一个链表。这样的话如果我们在数据页中查询一条记录，那么就需要遍历整个数据页中的记录行链表，这样的效率十分低下，为了解决这个问题，InnoDB的设计者为每个数据页都建立了一个目录，这个目录就是Page Directory。

- 将所有正常的记录（包括最大和最小记录，不包括标记为已删除的记录）划分为几个组。
- 每个组的最后一条记录（也就是组内主键最大的那条记录）的头信息中的n_owned属性表示该记录拥有多少条记录，也就是该组内共有几条记录。
- 将每个组的最后一条记录的地址偏移量单独提取出来按顺序存储到靠近页的尾部的地方，这个地方就是所谓的Page Directory，也就是页目录

![](/img/pageDirectory.png)

# MySQL索引数据结构


## 为什么实用B+数

- 多叉树，可以保证树的层数比较低，减少IO的次数
  - 一般千万级别的数据的索引，使用3到4层即可
- 叶子节点有序
- 每个节点可以存储多条数据，每个节点可以存储degree -1 条数据
-

## B+树的特点


# 索引优化

- 回表
- 覆盖索引
- 最左匹配
- 索引下推

## 建立索引的注意事项

- 建立索引的字段不宜太长
  - 字段短的话，则在一个数据页中可以存储更多的索引，从而可以减少IO的次数
  - 当然业务优先
- 表的主键最好使用自增、
  - 在自增的情况下，添加新的数据，只会影响最后面的数据页。
  - 而不自增的id，会导致页分裂
  - 比如身份证表中，身份证号是唯一的，但是不适合用来当主键，因为主键是聚簇索引，如果聚簇索引的大小是随机的，会导致很多务必要的数据行移动
  - 最好添加一列额外的id当做自增主键，哪怕用不到

## 索引失效条件

## 覆盖索引

## 索引合并

## 索引下推

## explain

### 字段解释

### 如果判断实用哪个索引

### key length的计算方法

### possible key 有但是 key 没有的情况

## 索引中null的问题，null会不会被加入到索引中？

# MySQL执行过程






[MySQL中IS NULL、IS NOT NULL、!=不能用索引](https://juejin.cn/post/6844903921450745863)
